//! Canonical trace schema for observability events.
//!
//! Defines the `beak.trace.v1` schema for capturing observability data from LLM
//! interactions, tool calls, and system events.
//!
//! All fields use `#[serde(default)]` for forward compatibility. The [`canonicalize`]
//! function fills required identifiers and computed metrics before serialization.
//! The `extensions` field provides an escape hatch for vendor-specific data.
//!
//! Future versions (e.g., `beak.trace.v2`) will be separate types discriminated by
//! `schema_version`.

use serde::{Deserialize, Serialize};

/// Top-level trace event representing a single observation.
///
/// Captures a specific occurrence (e.g., tool invocation, model completion) with its
/// context, inputs, outputs, and performance metrics. Events are identified by unique
/// IDs and can be correlated across distributed traces.
#[derive(Debug, Clone, Serialize, Deserialize, Default)]
pub struct TraceV1 {
    /// Schema version identifier. Should be `"beak.trace.v1"`.
    #[serde(default)]
    pub schema_version: String,

    /// Event type discriminator (e.g., `"tool.post"`, `"model.end"`).
    #[serde(default)]
    pub event: String,

    /// Event timestamp in ISO8601 UTC format (e.g., `"2025-11-13T10:30:00Z"`).
    #[serde(default)]
    pub timestamp: String,

    /// Correlation identifiers for distributed tracing.
    #[serde(default)]
    pub ids: Ids,

    /// Runtime context describing the execution environment.
    #[serde(default)]
    pub context: Ctx,

    /// Model or tool configuration parameters active for this event.
    #[serde(default)]
    pub configuration: Config,

    /// Input data consumed by the operation.
    #[serde(default)]
    pub inputs: Inputs,

    /// Output data produced by the operation.
    #[serde(default)]
    pub outputs: Outputs,

    /// Performance and cost metrics.
    #[serde(default)]
    pub metrics: Metrics,

    /// User-defined key-value labels for filtering and grouping events.
    #[serde(default)]
    pub labels: Vec<Label>,

    /// Boolean feature flags controlling event behavior.
    #[serde(default)]
    pub flags: Flags,

    /// Free-form JSON object for vendor-specific or experimental fields.
    ///
    /// Guaranteed to be a JSON object after canonicalization. Use this to attach
    /// custom metadata without modifying the schema.
    #[serde(default)]
    pub extensions: serde_json::Value,
}

/// Correlation identifiers for distributed tracing.
///
/// Links events across process boundaries and time, forming hierarchical traces
/// and conversation threads.
#[derive(Debug, Clone, Serialize, Deserialize, Default)]
pub struct Ids {
    /// Unique trace identifier shared by all events in a request flow.
    /// UUID v4 format. Generated by [`canonicalize`] if empty.
    #[serde(default)]
    pub trace_id: String,

    /// Unique span identifier for this event.
    /// UUID v4 format. Generated by [`canonicalize`] if empty.
    #[serde(default)]
    pub span_id: String,

    /// Parent span ID. Empty for root events.
    #[serde(default)]
    pub parent_span_id: String,

    /// Conversation identifier spanning multiple turns.
    #[serde(default)]
    pub conversation_id: String,

    /// Session identifier. Typically spans multiple conversations.
    #[serde(default)]
    pub session_id: String,
}

/// Runtime execution context.
///
/// Metadata about the plugin, host system, and user environment.
#[derive(Debug, Clone, Serialize, Deserialize, Default)]
pub struct Ctx {
    /// Name of the plugin or agent generating the event (e.g., `"beak"`).
    #[serde(default)]
    pub plugin: String,

    /// Semantic version of the plugin (e.g., `"1.2.3"`).
    #[serde(default)]
    pub plugin_version: String,

    /// Hostname or machine identifier where the event was generated.
    #[serde(default)]
    pub host: String,

    /// Process ID of the generating process.
    #[serde(default)]
    pub pid: u32,

    /// User's locale setting (e.g., `"en_US.UTF-8"`).
    #[serde(default)]
    pub locale: String,

    /// User's timezone (e.g., `"America/New_York"`).
    #[serde(default)]
    pub timezone: String,
}

/// Model or tool configuration parameters.
#[derive(Debug, Clone, Serialize, Deserialize, Default)]
pub struct Config {
    /// Model identifier (e.g., `"claude-3-sonnet-20240229"`, `"gpt-4"`).
    #[serde(default)]
    pub model: String,

    /// Sampling temperature. Range: `0.0` (deterministic) to `1.0+` (creative).
    #[serde(default)]
    pub temperature: f32,

    /// Nucleus sampling threshold. Range: `0.0` to `1.0`.
    #[serde(default)]
    pub top_p: f32,

    /// Top-K sampling limit (K most probable tokens).
    #[serde(default)]
    pub top_k: u32,

    /// Maximum tokens to generate in the response.
    #[serde(default)]
    pub max_tokens: u32,

    /// Random seed for reproducible generation. `0` if unset.
    #[serde(default)]
    pub seed: u32,

    /// Stop sequences that halt generation.
    #[serde(default)]
    pub stop_sequences: Vec<String>,
}

/// Input data consumed by the operation.
#[derive(Debug, Clone, Serialize, Deserialize, Default)]
pub struct Inputs {
    /// Conversation messages (role + content). Used in `model.*` events.
    #[serde(default)]
    pub messages_compact: Vec<Message>,

    /// Tool invocation details. Populated for `tool.*` events.
    #[serde(default)]
    pub tool: Tool,

    /// Retrieved context items from RAG (Retrieval-Augmented Generation).
    #[serde(default)]
    pub retrieval_items: Vec<RetrievalItem>,
}

/// Output data produced by the operation.
#[derive(Debug, Clone, Serialize, Deserialize, Default)]
pub struct Outputs {
    /// Generated text from the assistant or model. May be empty if only tool calls were generated.
    #[serde(default)]
    pub assistant_text: String,

    /// Tool calls requested by the model (name, arguments, execution status).
    #[serde(default)]
    pub tool_calls: Vec<ToolCall>,

    /// Reason generation stopped (e.g., `"stop"`, `"max_tokens"`, `"stop_sequence"`).
    #[serde(default)]
    pub finish_reason: String,

    /// Whether the output was truncated due to length limits.
    #[serde(default)]
    pub truncated: bool,

    /// Number of tokens in the input/prompt (duplicated from metrics for Beak compatibility).
    #[serde(default)]
    pub input_tokens: u32,

    /// Number of tokens in the completion/output (duplicated from metrics for Beak compatibility).
    #[serde(default)]
    pub output_tokens: u32,

    /// Total tokens consumed (duplicated from metrics for Beak compatibility).
    #[serde(default)]
    pub total_tokens: u32,

    /// Whether token counts are estimated (duplicated from metrics for Beak compatibility).
    #[serde(default)]
    pub tokens_estimated: bool,
}

/// Performance and cost metrics.
///
/// Some values may be computed by [`canonicalize`] if not provided.
#[derive(Debug, Clone, Serialize, Deserialize, Default)]
pub struct Metrics {
    /// Number of tokens in the input/prompt.
    #[serde(default)]
    pub prompt_tokens: u32,

    /// Number of tokens in the completion/output.
    #[serde(default)]
    pub completion_tokens: u32,

    /// Total tokens consumed. Computed by [`canonicalize`] if zero.
    #[serde(default)]
    pub total_tokens: u32,

    /// Whether token counts are estimated rather than exact.
    #[serde(default)]
    pub token_counts_estimated: bool,

    /// Latency breakdown by stage.
    #[serde(default)]
    pub latency_ms: Latency,

    /// Whether latency values are estimated rather than measured.
    #[serde(default)]
    pub latency_estimated: bool,

    /// Cost in USD for input tokens.
    #[serde(default)]
    pub input_cost_usd: f32,

    /// Cost in USD for output tokens.
    #[serde(default)]
    pub output_cost_usd: f32,

    /// Total cost in USD. Computed by [`canonicalize`] if input/output costs are present.
    #[serde(default)]
    pub total_cost_usd: f32,

    /// Quality score for the output. Range and interpretation are application-specific.
    #[serde(default)]
    pub quality_score: f32,
}

/// Latency measurements in milliseconds at different stages of processing.
#[derive(Debug, Clone, Serialize, Deserialize, Default)]
pub struct Latency {
    /// Time until first token generated (streaming latency).
    #[serde(default)]
    pub first_token: u32,

    /// Time spent in model provider's API.
    #[serde(default)]
    pub provider: u32,

    /// Total end-to-end latency including all processing.
    #[serde(default)]
    pub total: u32,
}

/// Boolean flags controlling event behavior.
#[derive(Debug, Clone, Serialize, Deserialize, Default)]
pub struct Flags {
    /// Whether this event was sampled for detailed logging.
    #[serde(default)]
    pub sampled: bool,
}

/// User-defined key-value label for filtering and grouping.
#[derive(Debug, Clone, Serialize, Deserialize, Default)]
pub struct Label {
    /// Label key (e.g., `"environment"`, `"team"`, `"experiment"`).
    #[serde(default)]
    pub key: String,

    /// Label value (e.g., `"production"`, `"ml-team"`, `"control"`).
    #[serde(default)]
    pub value: String,
}

/// Compact representation of a conversation message.
#[derive(Debug, Clone, Serialize, Deserialize, Default)]
pub struct Message {
    /// Message role: `"user"`, `"assistant"`, `"system"`.
    #[serde(default)]
    pub role: String,

    /// Message content (text).
    #[serde(default)]
    pub content: String,
}

/// Tool invocation metadata.
#[derive(Debug, Clone, Serialize, Deserialize, Default)]
pub struct Tool {
    /// Tool name (e.g., `"search"`, `"calculator"`).
    #[serde(default)]
    pub name: String,

    /// Tool version for tracking schema changes.
    #[serde(default)]
    pub version: String,

    /// Tool arguments as a JSON object.
    #[serde(default)]
    pub args: serde_json::Value,
}

/// Tool call result.
#[derive(Debug, Clone, Serialize, Deserialize, Default)]
pub struct ToolCall {
    /// Name of the tool that was called.
    #[serde(default)]
    pub name: String,

    /// Arguments passed to the tool as a JSON object.
    #[serde(default)]
    pub args: serde_json::Value,

    /// Execution status: `"success"`, `"error"`, `"timeout"`, etc.
    #[serde(default)]
    pub status: String,
}

/// Retrieved context item from RAG.
#[derive(Debug, Clone, Serialize, Deserialize, Default)]
pub struct RetrievalItem {
    /// Unique identifier for the retrieved item.
    #[serde(default)]
    pub id: String,

    /// Type of retrieved item (e.g., `"document"`, `"code_snippet"`).
    #[serde(default)]
    pub r#type: String,

    /// Relevance score (interpretation varies by retriever).
    #[serde(default)]
    pub score: f32,

    /// Size of the item in tokens.
    #[serde(default)]
    pub size_tokens: u32,
}

/// Normalizes a trace event to canonical form.
///
/// Ensures trace events are well-formed before serialization. Idempotent.
///
/// Sets defaults if empty:
/// - `schema_version`: `"beak.trace.v1"`
/// - `timestamp`: Current UTC timestamp (ISO8601)
/// - `trace_id` and `span_id`: UUID v4
/// - `total_tokens`: Sum of prompt and completion tokens
/// - `total_cost_usd`: Sum of input and output costs
/// - `extensions`: Empty JSON object if not already an object
pub fn canonicalize(t: &mut TraceV1) {
    use chrono::Utc;
    use uuid::Uuid;

    if t.schema_version.is_empty() {
        t.schema_version = "beak.trace.v1".into();
    }
    if t.timestamp.is_empty() {
        t.timestamp = Utc::now().to_rfc3339();
    }
    if t.ids.trace_id.is_empty() {
        t.ids.trace_id = Uuid::new_v4().to_string();
    }
    if t.ids.span_id.is_empty() {
        t.ids.span_id = Uuid::new_v4().to_string();
    }

    let total = t
        .metrics
        .prompt_tokens
        .saturating_add(t.metrics.completion_tokens);
    if t.metrics.total_tokens == 0 {
        t.metrics.total_tokens = total;
    }
    if (t.metrics.input_cost_usd + t.metrics.output_cost_usd) > 0.0 {
        t.metrics.total_cost_usd = t.metrics.input_cost_usd + t.metrics.output_cost_usd;
    }

    // Ensure extensions is an object
    if !t.extensions.is_object() {
        t.extensions = serde_json::json!({});
    }
}
